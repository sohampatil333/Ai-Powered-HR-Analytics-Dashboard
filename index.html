<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Analytics Dashboard</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js CDN for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js" charset="utf-8"></script>
    <style>
        /* Custom styles for a clean aesthetic */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font for corporate look */
            background-color: #f4f7fa; /* Light background */
            min-height: 100vh; /* Ensure body covers full viewport height */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* Rounded corners */
            /* Enhanced Shadow and Animation */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out; /* Smooth transition for hover effects */
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .card:hover {
            transform: translateY(-2px); /* Subtle lift effect */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937; /* Dark text */
        }
        .kpi-label {
            font-size: 0.9rem;
            color: #6b7280; /* Gray text */
            text-transform: uppercase;
        }
        .plotly-chart {
            flex-grow: 1;
            min-height: 300px;
        }
        /* Style for the custom file upload button */
        .file-upload-container {
            border: 2px dashed #9ca3af;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .file-upload-container:hover {
            border-color: #4f46e5; /* Indigo on hover */
            background-color: #eef2ff; /* Very light indigo background on hover */
        }

        /* Apply corporate color overrides to KPI values */
        #kpiAttritionRate { color: #DC2626; } /* Corporate Red */
        #kpiAvgIncome { color: #16A34A; } /* Corporate Green */
        #kpiAvgSatisfaction { color: #F59E0B; } /* Corporate Amber */

        /* Style for non-technical chart summaries */
        .chart-summary {
            font-size: 0.875rem;
            color: #4b5563; /* Darker gray for readability */
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb; /* Light separator */
            margin-bottom: 1rem;
        }
        
        /* Full-screen cover page styling */
        #coverPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); /* Gradient background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        .cover-card {
            background-color: white;
            padding: 4rem 3rem;
            border-radius: 1.5rem;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            max-width: 90%;
            width: 500px;
        }
    </style>
</head>
<body>

    <!-- ---------------------------------------------------- -->
    <!-- COVER PAGE: Only visible until file is uploaded -->
    <!-- ---------------------------------------------------- -->
    <div id="coverPage">
        <div class="cover-card">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-indigo-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
            </svg>
            <h1 class="text-3xl font-extrabold text-gray-900 mb-3">HR Analytics Dashboard</h1>
            <p class="text-gray-500 mb-6">Upload your HR data file to unlock interactive insights.</p>

            <!-- File Upload Area -->
            <label for="csvFileInputCover" class="file-upload-container block mt-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-8 w-8 text-indigo-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <p class="text-gray-700 font-semibold">Browse File (.csv)</p>
                <p id="uploadStatusCover" class="text-sm text-gray-500 mt-1">Accepts comma-separated values (CSV) files.</p>
            </label>
            <input type="file" id="csvFileInputCover" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
        </div>
    </div>


    <!-- ---------------------------------------------------- -->
    <!-- MAIN DASHBOARD CONTENT: Hidden until data is loaded -->
    <!-- ---------------------------------------------------- -->
    <div id="mainDashboard" class="p-4 md:p-8" style="display: none;">

        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">HR Analytics Dashboard</h1>
            <p class="text-gray-500 mt-1">Click on a department bar in the top left chart to drill down and filter all other metrics.</p>
        </header>

        <!-- Filters Section (Simplified for main view) -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">

            <!-- Placeholder for hidden upload status (used for internal tracking) -->
            <div class="card hidden">
                <p id="uploadStatus" class="text-sm text-gray-500 mt-1">Status: Initialized</p>
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
            </div>

            <!-- Department Filter Card -->
            <div class="card md:col-span-2">
                <label for="departmentFilter" class="kpi-label mb-2">Department Filter</label>
                <select id="departmentFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" onchange="updateDashboard()">
                    <option value="All">All Departments</option>
                </select>
            </div>

            <!-- Gender Filter Card -->
            <div class="card md:col-span-2">
                <label for="genderFilter" class="kpi-label mb-2">Gender Filter</label>
                <select id="genderFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" onchange="updateDashboard()">
                    <option value="All">All Genders</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
        </div>

        <!-- KPI Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Employees -->
            <div class="card text-center">
                <div class="kpi-label">Total Employees</div>
                <div id="kpiTotalEmployees" class="kpi-value">--</div>
            </div>
            <!-- Attrition Rate -->
            <div class="card text-center">
                <div class="kpi-label">Attrition Rate</div>
                <div id="kpiAttritionRate" class="kpi-value">--</div>
            </div>
            <!-- Average Monthly Income -->
            <div class="card text-center">
                <div class="kpi-label">Avg. Monthly Income</div>
                <div id="kpiAvgIncome" class="kpi-value">--</div>
            </div>
            <!-- Average Job Satisfaction -->
            <div class="card text-center">
                <div class="kpi-label">Avg. Job Satisfaction (1-4)</div>
                <div id="kpiAvgSatisfaction" class="kpi-value">--</div>
            </div>
        </div>

        <!-- Dynamic Summary Section -->
        <div class="card mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Data Insight Summary (Overall)</h3>
            <p id="dynamicSummary" class="text-gray-700 italic">Filters applied, loading summary...</p>
        </div>

        <!-- Visualizations (Charts) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Chart 1: Attrition by Department -->
            <div class="card">
                <p id="summary-AttritionByDepartment" class="chart-summary"></p>
                <div id="chartAttritionByDepartment" class="plotly-chart"></div>
            </div>

            <!-- Chart 2: Monthly Income Distribution by Job Role -->
            <div class="card">
                <p id="summary-MonthlyIncomeDistribution" class="chart-summary"></p>
                <div id="chartMonthlyIncomeDistribution" class="plotly-chart"></div>
            </div>

            <!-- Chart 3: Attrition by Age Group and Gender -->
            <div class="card">
                <p id="summary-AttritionByAgeGender" class="chart-summary"></p>
                <div id="chartAttritionByAgeGender" class="plotly-chart"></div>
            </div>

            <!-- Chart 4: Job Satisfaction vs Work-Life Balance (Heatmap) -->
            <div class="card">
                <p id="summary-SatisfactionWLBHeatmap" class="chart-summary"></p>
                <div id="chartSatisfactionWLBHeatmap" class="plotly-chart"></div>
            </div>

            <!-- Chart 5: Overtime Impact on Attrition (Donut) -->
            <div class="card">
                <p id="summary-OvertimeAttrition" class="chart-summary"></p>
                <div id="chartOvertimeAttrition" class="plotly-chart"></div>
            </div>

            <!-- Chart 6: Attrition by Education Field -->
            <div class="card">
                <p id="summary-AttritionByEducation" class="chart-summary"></p>
                <div id="chartAttritionByEducation" class="plotly-chart"></div>
            </div>

        </div>

    </div>

    <script>
        // Global variables
        let rawData = [];
        let filteredData = [];

        // Placeholder CSV data to ensure the dashboard loads immediately
        const placeholderCsvData = `EmpID,Age,AgeGroup,Attrition,BusinessTravel,DailyRate,Department,DistanceFromHome,Education,EducationField,EmployeeCount,EmployeeNumber,EnvironmentSatisfaction,Gender,HourlyRate,JobInvolvement,JobLevel,JobRole,JobSatisfaction,MaritalStatus,MonthlyIncome,SalarySlab,MonthlyRate,NumCompaniesWorked,Over18,OverTime,PercentSalaryHike,PerformanceRating,RelationshipSatisfaction,StandardHours,StockOptionLevel,TotalWorkingYears,TrainingTimesLastYear,WorkLifeBalance,YearsAtCompany,YearsInCurrentRole,YearsSinceLastPromotion,YearsWithCurrManager\r\nRM297,18,18-25,Yes,Travel_Rarely,230,Research & Development,3,3,Life Sciences,1,405,3,Male,54,3,1,Laboratory Technician,3,Single,1420,Upto 5k,25233,1,Y,No,13,3,3,80,0,0,2,3,0,0,0,0\r\nRM302,18,18-25,No,Travel_Rarely,812,Sales,10,3,Medical,1,411,4,Female,69,2,1,Sales Representative,3,Single,1200,Upto 5k,9724,1,Y,No,12,3,1,80,0,0,2,3,0,0,0,0\r\nRM458,18,18-25,Yes,Travel_Frequently,1306,Sales,5,3,Marketing,1,617,2,Female,75,2,1,Sales Representative,4,Single,1200,Upto 5k,25301,1,Y,No,13,3,4,80,0,0,2,3,0,0,0,0\r\nRM462,19,18-25,No,Travel_Rarely,1033,Research & Development,2,1,Life Sciences,1,623,4,Male,84,3,1,Laboratory Technician,4,Single,1900,Upto 5k,11613,1,Y,No,12,3,2,80,0,0,3,3,0,0,0,0\r\nRM759,59,55+,No,Travel_Rarely,1089,Sales,1,2,Technical Degree,1,1048,2,Male,66,3,3,Manager,4,Married,11904,10k-15k,11038,3,Y,Yes,14,3,3,80,1,14,1,1,6,4,0,4\r\nRM898,59,55+,No,Travel_Rarely,326,Sales,3,3,Life Sciences,1,1254,3,Female,48,2,2,Sales Executive,4,Single,5171,5k-10k,16490,5,Y,No,17,3,4,80,0,13,2,3,6,1,0,5\r\nRM920,59,55+,No,Travel_Rarely,1429,Research & Development,18,4,Medical,1,1283,4,Male,67,3,3,Manufacturing Director,4,Single,13726,10k-15k,21829,3,Y,Yes,13,3,1,80,0,30,4,3,5,3,4,3\r\nRM921,59,55+,No,Travel_Rarely,1309,Research & Development,2,3,Medical,1,1284,4,Male,61,2,4,Manager,3,Married,18228,15k-20k,25304,3,Y,Yes,12,3,3,80,1,11,2,3,8,7,0,7\r\nRM2000,59,55+,Yes,Travel_Rarely,818,Research & Development,6,2,Medical,1,2772,3,Female,93,3,4,Manager,2,Married,17808,15k-20k,20466,6,Y,No,13,3,4,80,0,17,3,2,1,0,0,0\r\nRM2002,59,55+,No,Travel_Rarely,447,Research & Development,10,3,Life Sciences,1,2775,4,Male,90,4,5,Manager,4,Married,19237,15k-20k,22416,2,Y,No,12,3,2,80,1,30,3,3,16,14,1,15`;

        // Corporate Color Palette for Plotly Charts (Defined globally for use in all functions)
        const corporateColors = {
            primary: '#4338CA', // Indigo 700 - Professional/Neutral
            secondary: '#2563EB', // Blue 600 - Male/Total
            female: '#EC4899', // Pink 500 - Female Accent
            attritionYes: '#DC2626', // Red 600 - Attrition YES
            attritionNo: '#A3A3A3', // Gray 500 - Attrition NO (Soft contrast)
            income: '#10B981', // Green 500 - Income/Positive
            heatmapScale: 'Sunsetdark' // A built-in sophisticated scale
        };

        /**
         * Simple CSV parser that handles the first row as headers.
         * @param {string} text - The CSV content as a string.
         * @returns {Array<Object>} Array of objects representing the rows.
         */
        function parseCSV(text) {
            const lines = text.trim().split('\r\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length === 0) return [];

            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                if (values.length === headers.length) {
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index].trim();
                    });
                    data.push(row);
                }
            }
            return data;
        }

        /**
         * Handles the file upload event, parses the CSV, and initializes the dashboard.
         * @param {Event} event - The file input change event.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            // Function to update status text on the cover page
            const updateCoverStatus = (message, isError = false) => {
                const statusEl = document.getElementById('uploadStatusCover');
                statusEl.textContent = message;
                if (isError) {
                    statusEl.classList.remove('text-gray-500');
                    statusEl.classList.add('text-red-500', 'font-bold');
                } else {
                    statusEl.classList.remove('text-red-500', 'font-bold');
                    statusEl.classList.add('text-green-500', 'font-bold');
                }
            };

            updateCoverStatus('Loading file...');

            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    rawData = parseCSV(content);

                    if (rawData.length === 0) {
                        updateCoverStatus('Error: No valid data records found in the file.', true);
                        return;
                    }

                    updateCoverStatus(`File loaded successfully. ${rawData.length} records found. Opening dashboard...`);

                    // 1. Hide the cover page
                    document.getElementById('coverPage').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('coverPage').style.display = 'none';
                        // 2. Show the main dashboard
                        document.getElementById('mainDashboard').style.display = 'block';
                        // 3. Initialize the dashboard with the new data
                        initializeDashboard();
                    }, 500); // Wait for fade out animation

                } catch (error) {
                    console.error("Error parsing CSV:", error);
                    updateCoverStatus('Error parsing file. Check console for details.', true);
                }
            };

            reader.onerror = () => {
                updateCoverStatus('Error reading file.', true);
            };

            reader.readAsText(file);
        }

        /**
         * Populates the filter dropdowns based on the data.
         */
        function populateFilters() {
            const deptFilter = document.getElementById('departmentFilter');
            const uniqueDepartments = new Set(rawData.map(d => d.Department).filter(d => d));

            // Store the current value to attempt to restore it later
            const currentValue = deptFilter.value;

            // Clear existing options
            deptFilter.innerHTML = '<option value="All">All Departments</option>';

            uniqueDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });

            // Attempt to restore the current value if it still exists
            if (currentValue && uniqueDepartments.has(currentValue)) {
                deptFilter.value = currentValue;
            }
        }

        /**
         * Filters the raw data based on current dropdown selections.
         */
        function filterData() {
            const department = document.getElementById('departmentFilter').value;
            const gender = document.getElementById('genderFilter').value;

            filteredData = rawData.filter(d => {
                let passesDept = department === 'All' || d.Department === department;
                let passesGender = gender === 'All' || d.Gender === gender;
                return passesDept && passesGender;
            });
        }

        /**
         * Calculates and updates the Key Performance Indicator (KPI) cards.
         */
        function updateKPIs() {
            const totalEmployees = filteredData.length;
            const attritionCount = filteredData.filter(d => d.Attrition === 'Yes').length;
            const attritionRate = totalEmployees > 0 ? (attritionCount / totalEmployees) * 100 : 0;
            const totalIncome = filteredData.reduce((sum, d) => sum + (parseInt(d.MonthlyIncome) || 0), 0);
            const avgIncome = totalEmployees > 0 ? totalIncome / totalEmployees : 0;
            const totalSatisfaction = filteredData.reduce((sum, d) => sum + (parseInt(d.JobSatisfaction) || 0), 0);
            const avgSatisfaction = totalEmployees > 0 ? totalSatisfaction / totalEmployees : 0;

            document.getElementById('kpiTotalEmployees').textContent = totalEmployees.toLocaleString();
            document.getElementById('kpiAttritionRate').textContent = `${attritionRate.toFixed(1)}%`;
            document.getElementById('kpiAvgIncome').textContent = `$${Math.round(avgIncome).toLocaleString()}`;
            document.getElementById('kpiAvgSatisfaction').textContent = avgSatisfaction.toFixed(2);
        }

        /**
         * Generates the dynamic text summary.
         */
        function updateDynamicSummary() {
            const totalEmployees = filteredData.length;
            if (totalEmployees === 0) {
                document.getElementById('dynamicSummary').textContent = "No data available based on the current filter selections.";
                return;
            }

            const currentAttritionRate = parseFloat(document.getElementById('kpiAttritionRate').textContent);
            const department = document.getElementById('departmentFilter').value;
            const departmentText = department === 'All' ? 'the entire workforce' : `the **${department}** department`;

            // Calculate attrition by department (only if global view)
            let insight = `The current analysis covers **${totalEmployees.toLocaleString()}** employees within ${departmentText}.`;

            if (department === 'All') {
                const attritionByDept = rawData.reduce((acc, d) => { // Use rawData to find overall highest
                    if (!acc[d.Department]) acc[d.Department] = { total: 0, yes: 0 };
                    acc[d.Department].total++;
                    if (d.Attrition === 'Yes') acc[d.Department].yes++;
                    return acc;
                }, {});

                let highestAttritionDept = 'N/A';
                let maxAttritionRate = -1;

                for (const dept in attritionByDept) {
                    const rate = (attritionByDept[dept].yes / attritionByDept[dept].total) * 100;
                    if (rate > maxAttritionRate) {
                        maxAttritionRate = rate;
                        highestAttritionDept = dept;
                    }
                }
                insight += ` The **overall attrition rate** is **${currentAttritionRate.toFixed(1)}%**. The highest risk area is typically the **${highestAttritionDept}** department.`;
            } else {
                 insight += ` The attrition rate for this group is **${currentAttritionRate.toFixed(1)}%**. Analyze the charts below to understand the specific drivers (e.g., income or overtime) within this filtered department.`;
            }


            document.getElementById('dynamicSummary').innerHTML = insight.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        /**
         * Helper function to prepare data for charts
         */
        const prepareChartData = (category, includeAttrition = true) => {
            const results = filteredData.reduce((acc, d) => {
                const cat = d[category];
                if (!acc[cat]) acc[cat] = { total: 0, yes: 0 };
                acc[cat].total++;
                if (includeAttrition && d.Attrition === 'Yes') acc[cat].yes++;
                return acc;
            }, {});
            return results;
        };


        /**
         * Generates and updates non-technical summaries for all charts.
         */
        function updateChartSummaries() {
            if (filteredData.length === 0) {
                const emptyMessage = 'No data available to generate insights.';
                document.getElementById('summary-AttritionByDepartment').textContent = emptyMessage;
                document.getElementById('summary-MonthlyIncomeDistribution').textContent = emptyMessage;
                document.getElementById('summary-AttritionByAgeGender').textContent = emptyMessage;
                document.getElementById('summary-SatisfactionWLBHeatmap').textContent = emptyMessage;
                document.getElementById('summary-OvertimeAttrition').textContent = emptyMessage;
                document.getElementById('summary-AttritionByEducation').textContent = emptyMessage;
                return;
            }

            // --- Summary 1: Attrition by Department ---
            (function summaryAttritionByDepartment() {
                const data = prepareChartData('Department');
                const departments = Object.keys(data);
                if (departments.length === 0) return;

                let maxRate = -1;
                let maxDept = '';

                departments.forEach(dept => {
                    const total = data[dept].total;
                    const yes = data[dept].yes;
                    const rate = total > 0 ? (yes / total) * 100 : 0;
                    if (rate > maxRate) { maxRate = rate; maxDept = dept; }
                });

                document.getElementById('summary-AttritionByDepartment').innerHTML =
                    `**Attrition Risk:** Shows employee turnover counts by department. Click on a department bar to filter the whole dashboard. The **${maxDept}** department currently has the highest turnover rate (${maxRate.toFixed(1)}%).`;
            })();

            // --- Summary 2: Monthly Income Distribution by Job Role ---
            (function summaryMonthlyIncomeDistribution() {
                const jobRoles = [...new Set(filteredData.map(d => d.JobRole))].filter(r => r);
                const roleIncomes = jobRoles.map(role => {
                    const incomes = filteredData.filter(d => d.JobRole === role).map(d => parseInt(d.MonthlyIncome) || 0);
                    const avg = incomes.reduce((a, b) => a + b, 0) / incomes.length;
                    return { role, avg };
                }).sort((a, b) => b.avg - a.avg);

                if (roleIncomes.length === 0) return;

                const highestRole = roleIncomes[0];

                document.getElementById('summary-MonthlyIncomeDistribution').innerHTML =
                    `**Compensation Equity:** Box plots show the average income (green line) and spread of salaries for each Job Role. **${highestRole.role}** has the highest average income ($${Math.round(highestRole.avg).toLocaleString()}).`;
            })();

            // --- Summary 3: Attrition by Age Group and Gender ---
            (function summaryAttritionByAgeGender() {
                const attritionData = filteredData.filter(d => d.Attrition === 'Yes');
                if (attritionData.length === 0) {
                    document.getElementById('summary-AttritionByAgeGender').innerHTML = "No attrition recorded in the current selection. Retention is 100% (within this group).";
                    return;
                }

                const ageGroupCounts = attritionData.reduce((acc, d) => {
                    acc[d.AgeGroup] = (acc[d.AgeGroup] || 0) + 1;
                    return acc;
                }, {});

                const mostAffectedGroup = Object.keys(ageGroupCounts).sort((a, b) => ageGroupCounts[b] - ageGroupCounts[a])[0];

                document.getElementById('summary-AttritionByAgeGender').innerHTML =
                    `**Demographic Insight:** Shows which Age Group and Gender are leaving. The highest count of departures is concentrated in the **${mostAffectedGroup}** age group, indicating a key retention challenge.`;
            })();

            // --- Summary 4: Job Satisfaction vs Work-Life Balance ---
            (function summarySatisfactionWLBHeatmap() {
                const highlySatisfied = filteredData.filter(d => parseInt(d.JobSatisfaction) >= 3);
                const countWLB3or4 = highlySatisfied.filter(d => parseInt(d.WorkLifeBalance) >= 3).length;
                const percentage = highlySatisfied.length > 0 ? (countWLB3or4 / highlySatisfied.length) * 100 : 0;

                document.getElementById('summary-SatisfactionWLBHeatmap').innerHTML =
                    `**Quality of Life:** The darker colors show where most employees fall. Approximately **${percentage.toFixed(0)}%** of highly satisfied employees also rate their Work-Life Balance as 'Better' or 'Best'.`;
            })();

            // --- Summary 5: Overtime Impact on Attrition (Donut) ---
            (function summaryOvertimeAttrition() {
                const totalYes = filteredData.filter(d => d.OverTime === 'Yes').length;
                const attritionWithOvertime = filteredData.filter(d => d.OverTime === 'Yes' && d.Attrition === 'Yes').length;
                const attritionWithoutOvertime = filteredData.filter(d => d.OverTime === 'No' && d.Attrition === 'Yes').length;

                const totalAttrition = attritionWithOvertime + attritionWithoutOvertime;
                const overtimeContribution = totalAttrition > 0 ? (attritionWithOvertime / totalAttrition) * 100 : 0;

                document.getElementById('summary-OvertimeAttrition').innerHTML =
                    `**Overtime Risk:** This donut chart highlights how many leavers were working overtime (red slice). Of all employees who left, **${overtimeContribution.toFixed(0)}%** were employees who worked overtime.`;
            })();

            // --- Summary 6: Attrition by Education Field ---
            (function summaryAttritionByEducation() {
                const data = prepareChartData('EducationField');
                const fields = Object.keys(data);
                const attritionRates = fields.map(f => (data[f].yes / data[f].total) * 100);

                const attritionRatesSorted = fields.map(f => ({
                    field: f,
                    rate: (data[f].yes / data[f].total) * 100
                })).sort((a, b) => b.rate - a.rate);

                const highestField = attritionRatesSorted[0];

                document.getElementById('summary-AttritionByEducation').innerHTML =
                    `**Educational Focus:** Shows the turnover rate by the employee's education field. Employees from **${highestField.field}** show the highest attrition rate (${highestField.rate.toFixed(1)}%).`;
            })();

             // Find and replace **bolded** text with <strong> tags
            document.querySelectorAll('.chart-summary').forEach(el => {
                el.innerHTML = el.innerHTML.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            });
        }


        /**
         * Renders the six Plotly charts.
         */
        function renderCharts() {
            // --- Chart 1: Attrition by Department (Grouped Bar) ---
            (function plotAttritionByDepartment() {
                const data = prepareChartData('Department');
                const departments = Object.keys(data);
                const yes = departments.map(d => data[d].yes);
                const no = departments.map(d => data[d].total - data[d].yes);

                const trace1 = {
                    x: departments, y: yes, name: 'Attrition: Yes', type: 'bar', marker: { color: corporateColors.attritionYes }
                };
                const trace2 = {
                    x: departments, y: no, name: 'Attrition: No', type: 'bar', marker: { color: corporateColors.primary }
                };

                const layout = {
                    title: 'Attrition Count by Department (Click to Filter)', barmode: 'group',
                    xaxis: { title: 'Department' }, yaxis: { title: 'Number of Employees' },
                    margin: { t: 40, b: 80, l: 50, r: 20 }
                };

                const chartElementId = 'chartAttritionByDepartment';
                Plotly.newPlot(chartElementId, [trace1, trace2], layout, { responsive: true, displayModeBar: false });

                // Add interactive click listener (Tableau-like drill-down)
                const chartElement = document.getElementById(chartElementId);
                chartElement.on('plotly_click', function(data) {
                    if (data.points.length > 0) {
                        const clickedDepartment = data.points[0].x;
                        const deptFilter = document.getElementById('departmentFilter');

                        if (deptFilter.value === clickedDepartment) {
                            // If the same department is clicked, reset the filter to 'All'
                            deptFilter.value = 'All';
                        } else {
                            // Filter to the clicked department
                            deptFilter.value = clickedDepartment;
                        }
                        updateDashboard();
                    }
                });
            })();

            // --- Chart 2: Monthly Income Distribution by Job Role (Box Plot) ---
            (function plotMonthlyIncomeDistribution() {
                const jobRoles = [...new Set(filteredData.map(d => d.JobRole))];
                const traces = jobRoles.map(role => ({
                    y: filteredData.filter(d => d.JobRole === role).map(d => parseInt(d.MonthlyIncome)),
                    name: role, type: 'box', boxpoints: false,
                    marker: { color: corporateColors.income }
                }));

                const layout = {
                    title: 'Monthly Income Distribution by Job Role',
                    yaxis: { title: 'Monthly Income ($)' },
                    margin: { t: 40, b: 80, l: 60, r: 20 }
                };
                Plotly.newPlot('chartMonthlyIncomeDistribution', traces, layout, { responsive: true, displayModeBar: false });
            })();

            // --- Chart 3: Attrition by Age Group and Gender (Grouped Bar) ---
            (function plotAttritionByAgeGender() {
                const data = filteredData.filter(d => d.Attrition === 'Yes').reduce((acc, d) => {
                    const key = d.AgeGroup;
                    if (!acc[key]) acc[key] = { Male: 0, Female: 0 };
                    acc[key][d.Gender]++;
                    return acc;
                }, {});

                const ageGroups = Object.keys(data).sort();
                const males = ageGroups.map(g => data[g] ? data[g].Male : 0);
                const females = ageGroups.map(g => data[g] ? data[g].Female : 0);

                const traceMale = {
                    x: ageGroups, y: males, name: 'Male Attrition', type: 'bar', marker: { color: corporateColors.secondary }
                };
                const traceFemale = {
                    x: ageGroups, y: females, name: 'Female Attrition', type: 'bar', marker: { color: corporateColors.female }
                };

                const layout = {
                    title: 'Attrition Count by Age Group and Gender', barmode: 'group',
                    xaxis: { title: 'Age Group' }, yaxis: { title: 'Attrition Count' },
                    margin: { t: 40, b: 80, l: 50, r: 20 }
                };
                Plotly.newPlot('chartAttritionByAgeGender', [traceMale, traceFemale], layout, { responsive: true, displayModeBar: false });
            })();

            // --- Chart 4: Job Satisfaction vs Work-Life Balance (Heatmap) ---
            (function plotSatisfactionWLBHeatmap() {
                const counts = filteredData.reduce((acc, d) => {
                    const sat = parseInt(d.JobSatisfaction); // Y-axis
                    const wlb = parseInt(d.WorkLifeBalance); // X-axis

                    if (!acc[sat]) acc[sat] = {};
                    acc[sat][wlb] = (acc[sat][wlb] || 0) + 1;
                    return acc;
                }, {});

                const wlbLabels = ['Bad (1)', 'Good (2)', 'Better (3)', 'Best (4)'];
                const satLabels = ['Low (1)', 'Medium (2)', 'High (3)', 'Very High (4)'];

                // Prepare z-data (counts)
                const z = satLabels.map((_, i) =>
                    wlbLabels.map((_, j) => counts[i + 1] ? counts[i + 1][j + 1] || 0 : 0)
                ).reverse(); // Reverse for correct Y-axis order

                const data = [{
                    z: z, x: wlbLabels, y: satLabels.slice().reverse(), type: 'heatmap',
                    colorscale: corporateColors.heatmapScale,
                    hovertemplate: 'WLB: %{x}<br>Satisfaction: %{y}<br>Count: %{z}<extra></extra>'
                }];

                const layout = {
                    title: 'Job Satisfaction vs Work-Life Balance (Employee Count)',
                    xaxis: { title: 'Work-Life Balance' }, yaxis: { title: 'Job Satisfaction' },
                    margin: { t: 40, b: 80, l: 80, r: 20 }
                };
                Plotly.newPlot('chartSatisfactionWLBHeatmap', data, layout, { responsive: true, displayModeBar: false });
            })();

            // --- Chart 5: Overtime Impact on Attrition (Donut) ---
            (function plotOvertimeAttrition() {
                const overtimeAttrition = filteredData.reduce((acc, d) => {
                    const key = `${d.OverTime}-${d.Attrition}`; // e.g., 'Yes-Yes', 'No-No', 'Yes-No'
                    acc[key] = (acc[key] || 0) + 1;
                    return acc;
                }, {});

                const labels = ['Overtime: Yes, Attrition: Yes', 'Overtime: No, Attrition: Yes', 'Overtime: Yes, Attrition: No', 'Overtime: No, Attrition: No'];
                const values = [
                    overtimeAttrition['Yes-Yes'] || 0,
                    overtimeAttrition['No-Yes'] || 0,
                    overtimeAttrition['Yes-No'] || 0,
                    overtimeAttrition['No-No'] || 0
                ];
                // New corporate-focused color array for the donut
                const colors = [
                    corporateColors.attritionYes, // Yes-Yes (High impact red)
                    '#FCA5A5', // No-Yes (Lighter red for context)
                    corporateColors.primary, // Yes-No (Primary color)
                    corporateColors.attritionNo // No-No (Neutral/Gray)
                ];

                const data = [{
                    labels: labels, values: values, type: 'pie',
                    hole: .4,
                    marker: { colors: colors },
                    hovertemplate: '<b>%{label}</b><br>Count: %{value}<br>Percent: %{percent}<extra></extra>'
                }];

                const layout = {
                    title: 'Overtime Impact on Attrition',
                    margin: { t: 40, b: 20, l: 20, r: 20 },
                    legend: { orientation: 'h', y: -0.1 }
                };
                Plotly.newPlot('chartOvertimeAttrition', data, layout, { responsive: true, displayModeBar: false });
            })();

            // --- Chart 6: Attrition by Education Field (Bar) ---
            (function plotAttritionByEducation() {
                const data = prepareChartData('EducationField');
                const fields = Object.keys(data);
                const attritionRates = fields.map(f => (data[f].yes / data[f].total) * 100);

                const dataPlot = [{
                    x: fields, y: attritionRates, type: 'bar',
                    // Dynamic coloring based on rate, using corporate red/indigo
                    marker: { color: attritionRates.map(rate => rate > 15 ? corporateColors.attritionYes : corporateColors.primary) }
                }];

                const layout = {
                    title: 'Attrition Rate by Education Field',
                    xaxis: { title: 'Education Field' },
                    yaxis: { title: 'Attrition Rate (%)', range: [0, Math.min(100, Math.max(...attritionRates) * 1.2 || 20)] },
                    margin: { t: 40, b: 80, l: 50, r: 20 }
                };
                Plotly.newPlot('chartAttritionByEducation', dataPlot, layout, { responsive: true, displayModeBar: false });
            })();
        }

        /**
         * Main function to update all dashboard elements based on current filters.
         */
        function updateDashboard() {
            filterData();
            updateKPIs();
            updateDynamicSummary();
            renderCharts();
            updateChartSummaries(); // New step to update descriptive summaries
        }

        /**
         * Initializes the dashboard upon first load or successful data upload.
         */
        function initializeDashboard() {
            if (rawData.length === 0) {
                // If no rawData, we assume we are still on the cover page or failed to load
                document.getElementById('uploadStatus').textContent = 'Error: No data to display.';
                return;
            }
            populateFilters();
            updateDashboard();
        }

        // --- Initialization on Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attach the file handler to the cover page input
            document.getElementById('csvFileInputCover').addEventListener('change', handleFileUpload);
        });

    </script>
</body>
</html>
